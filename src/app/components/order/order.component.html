<div class="container">
    <div class="intro-section">
      <h1>{{ 'order.title' | translate }}</h1>
    </div>
  
    <form [formGroup]="orderForm" *ngIf="cartItems.length > 0">
      <div class="row">
        <div class="col-md-6">
          <h2 class="product-header">{{ 'order.recipientInfo' | translate }}</h2>
  
          <div class="mb-3">
            <label for="fullname" class="form-label">{{ 'order.fullname' | translate }}</label>
            <input type="text" formControlName="fullname" class="form-control" id="fullname"
                   [class.is-invalid]="orderForm.get('fullname')!.invalid && orderForm.get('fullname')!.touched">
            <div *ngIf="orderForm.get('fullname')!.invalid && orderForm.get('fullname')!.touched" class="invalid-feedback">
              {{ 'order.fullnameRequired' | translate }}
            </div>
          </div>
  
          <div class="mb-3">
            <label for="email" class="form-label">{{ 'order.email' | translate }}</label>
            <input type="text" formControlName="email" class="form-control" id="email"
                   [class.is-invalid]="orderForm.get('email')!.invalid && orderForm.get('email')!.touched">
            <div *ngIf="orderForm.get('email')!.invalid && orderForm.get('email')!.touched" class="invalid-feedback">
              {{ orderForm.get('email')!.hasError('email') ? ('order.emailInvalid' | translate) : ('order.emailRequired' | translate) }}
            </div>
          </div>
  
          <div class="mb-3">
            <label for="phone" class="form-label">{{ 'order.phone' | translate }}</label>
            <input type="text" class="form-control" formControlName="phone_number" id="phone"
                   [class.is-invalid]="orderForm.get('phone_number')!.invalid && orderForm.get('phone_number')!.touched">
            <div *ngIf="orderForm.get('phone_number')!.invalid && orderForm.get('phone_number')!.touched" class="invalid-feedback">
              {{ 'order.phoneRequired' | translate }}
            </div>
          </div>
  
          <div class="mb-3">
            <label for="address" class="form-label">{{ 'order.address' | translate }}</label>
            <input type="text" class="form-control" formControlName="address" id="address"
                   [class.is-invalid]="orderForm.get('address')!.invalid && orderForm.get('address')!.touched">
            <div *ngIf="orderForm.get('address')!.invalid && orderForm.get('address')!.touched" class="invalid-feedback">
              {{ 'order.addressRequired' | translate }}
            </div>
          </div>
  
          <div class="mb-3">
            <label for="note" class="form-label">{{ 'order.note' | translate }}</label>
            <input type="text" class="form-control" formControlName="note" id="note">
          </div>
  
          <div class="mb-3">
            <label for="shippingMethod">{{ 'order.shippingMethod' | translate }}</label>
            <select class="form-control" id="shippingMethod" formControlName="shipping_method">
              <option value="express">{{ 'order.shippingExpress' | translate }}</option>
              <option value="normal">{{ 'order.shippingNormal' | translate }}</option>
            </select>
          </div>
  
          <div class="mb-3">
            <label for="paymentMethod">{{ 'order.paymentMethod' | translate }}</label>
            <select class="form-control" id="paymentMethod" formControlName="payment_method" (change)="onPaymentMethodChange()">
              <option value="cod">{{ 'order.paymentCod' | translate }}</option>
              <option value="visa">{{ 'order.paymentVisa' | translate }}</option>
            </select>
          </div>
  
          <div *ngIf="orderForm.get('payment_method')?.value === 'visa'" class="visa-card-form mt-3">
            <label for="card-element">{{ 'order.visaInfo' | translate }}</label>
            <div id="card-element" class="form-control" style="padding: 12px;"></div>
            <div id="card-errors" class="text-danger mt-2" role="alert"></div>
          </div>
        </div>
  
        <div class="col-md-6">
          <h2 class="product-order">{{ 'order.orderedProducts' | translate }}</h2>
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col" class="text-start">{{ 'order.product' | translate }}</th>
                <th scope="col">{{ 'order.quantity' | translate }}</th>
                <th scope="col">{{ 'order.unitPrice' | translate }}</th>
                <th scope="col">{{ 'order.totalPrice' | translate }}</th>
                <th scope="col">{{ 'order.action' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let item of cartItems">
                <tr>
                  <td>
                    <div class="product-info">
                      <img [src]="item.product.thumbnail" alt="Product Image" class="product-image" />
                      <div class="product-name-wrapper">
                        <span class="product-name">{{ item.product.name }}</span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="quantity-control d-flex align-items-center">
                      <button class="btn btn-sm btn-outline-secondary" (click)="decreaseQuantity(item.product.id)">−</button>
                      <span class="mx-2">{{ item.quantity }}</span>
                      <button class="btn btn-sm btn-outline-secondary" (click)="increaseQuantity(item.product.id)">+</button>
                    </div>
                  </td>
                  <td>{{ item.product.price | number:'1.2-2' }}</td>
                  <td>{{ (item.product.price * item.quantity) | number:'1.2-2' }}</td>
                  <td>
                    <button type="button" class="btn btn-danger btn-sm" (click)="removeFromCart(item.product.id)">
                      <i class="bi bi-trash"></i>
                      <span class="btn-text">{{ 'order.delete' | translate }}</span>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
  
          <div class="text-start mt-3">
            <h4 class="header-text text-end">{{ 'order.totalAmount' | translate }}: {{ totalAmount | number:'1.2-2'}}</h4>
            <div *ngIf="couponApplied" class="text-end text-success">
              {{ 'order.discount' | translate }}: -{{ discountAmount | number:'1.2-2' }} ({{ orderForm.get('coupon_code')?.value }})
            </div>
            <h4 class="header-text text-end">
              {{ 'order.finalAmount' | translate }}: {{ Math.max(totalAmount - discountAmount, 0) | number:'1.2-2' }}
            </h4>
          </div>
  
          <div class="mt-3">
            <h4 class="product-header">{{ 'order.couponTitle' | translate }}</h4>
            <div class="input-group">
              <input type="text" class="form-control" formControlName="coupon_code"
                     [placeholder]="'order.couponPlaceholder' | translate" (keydown.enter)="onCouponEntered()"
                     (blur)="onCouponEntered()" />
              <span class="input-group-text" *ngIf="couponApplied">✓</span>
            </div>
  
            <div *ngIf="couponError" class="text-danger mt-1">
              {{ couponError }}
            </div>
          </div>
  
          <div class="text-start mt-3">
            <button (click)="placeOrder()"
                    [disabled]="isProcessing || (orderForm.get('coupon_code')?.value && !couponApplied) || !orderForm.valid"
                    class="btn btn-gradient" type="button">
              {{ isProcessing ? ('order.processing' | translate) : ('order.placeOrder' | translate) }}
            </button>
          </div>
        </div>
      </div>
    </form>
  
    <div *ngIf="cartItems.length === 0" class="text-center my-5">
      <p class="empty-cart-text">{{ 'order.emptyCart' | translate }}</p>
    </div>
  </div>